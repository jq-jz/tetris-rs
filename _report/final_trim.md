# 基于 Rust 的俄罗斯方块游戏开发报告

## 一、项目概述

本项目使用 Rust 语言和 Bevy 游戏框架，从零实现了一个功能完整的经典俄罗斯方块游戏。

| 姓名 | 学号         |
| ---- | ------------ |
| 吴锋 | 922116850527 |
| 蒋琦 | 922106840418 |

## 二、技术栈

- **语言与工具**: Rust 1.90.0, Cargo 1.90.0
- **核心框架**: Bevy 0.17.2 (框架)
- **依赖库**: rand 0.9 (随机数生成)
- **平台**: Windows 11 / macOS

## 三、核心架构

### ECS 架构模式

采用 Bevy 的**实体组件系统 (ECS)** 作为核心架构：

- **实体 (Entity)**: 游戏对象的唯一 ID（方块格、UI 文字等）
- **组件 (Component)**: 实体的纯数据属性（位置、外观、标签）
- **系统 (System)**: 处理特定组件集合的逻辑函数
- **资源 (Resource)**: 全局状态管理（GameState、GameBoard）

### 游戏循环

每帧按序执行四个核心系统：

1. **handle_player_input** - 处理玩家输入
2. **update_game_logic** - 更新游戏逻辑（下落、锁定、消行、生成）
3. **render_game** - 渲染游戏画面
4. **update_ui** - 更新 UI 文本

## 四、实现要点

### 功能需求

- 方块移动、旋转、软降、硬降
- 触底自动锁定
- 消行计分、游戏结束判断
- 分数显示、下一个方块预览
- 暂停/继续、重新开始

### 项目结构

```
src/
├── main.rs              # 程序入口
├── components.rs        # ECS 组件定义
├── resources.rs         # 全局资源
├── tetromino.rs         # 方块类型与逻辑
├── constants.rs         # 游戏常量与工具函数
└── systems/             # 游戏系统
    ├── player_input.rs  # 输入处理
    ├── rendering.rs     # 渲染与 UI
    └── game.rs          # 核心逻辑
```

### 界面设计

- **窗口**: 800x700 像素，10x20 网格（每格 30px）
- **坐标系统**: `grid_to_world()` 函数将网格坐标转换为世界坐标
- **分层渲染**: 背景网格 (z=0) → 锁定方块 (z=1) → 当前方块 (z=2)
- **UI 布局**: 左上角显示分数，右上角预览下一个方块，中央显示游戏状态

### 方块设计

- **7 种方块类型**: I、O、T、S、Z、J、L，各有独特颜色
- **形状定义**: 使用相对坐标数组，简化旋转和碰撞检测

### 交互控制

**键盘操作** (支持方向键和 WASD):

- 左移/右移、旋转、软降（加速下落）
- 硬降（Space 直接落地）
- 暂停/继续 (ESC)、退出 (Q)、重新开始 (游戏结束后 Space)

**状态管理**: 通过 `GameState` 和 `GameBoard` 两个全局资源实现单一数据源 (Single Source of Truth)

### 核心逻辑

游戏逻辑系统每帧执行四个阶段：

1. **方块下落**: 计时器控制，每 0.8 秒下移一格
2. **方块锁定**: Lock Delay 机制，触底后 0.2 秒内可调整位置
3. **消行计分**: 消除满行，上方方块下移，计分（1-4 行得 100/300/500/800 分）
4. **生成新方块**: 从 7-Bag 系统取出下一个方块

**碰撞检测**: 检查方块是否超出边界或与已锁定方块重叠

**旋转系统**: 使用旋转矩阵实现四个方向（0°/90°/180°/270°）的顺时针旋转

## 五、项目总结

### 功能完成度

项目成功完成全部基础需求：

| 功能                                | 状态 |
| :---------------------------------- | :--: |
| 方块移动、旋转、软降、硬降          |  ✓   |
| 方块自动下落与锁定（含 Lock Delay） |  ✓   |
| 消行计分、游戏结束判断              |  ✓   |
| 分数显示、下一个方块预览            |  ✓   |
| 暂停/继续、重新开始                 |  ✓   |

### 架构优势

当前设计具有良好的可扩展性，可通过添加组件和系统轻松实现新功能（如关卡系统、音效系统等），为后续优化和迭代打下基础。

## 六、附录

### 源码与运行

- **仓库地址**: https://github.com/jq-jz/tetris-rs
- **快速开始**:
  ```bash
  git clone https://github.com/jq-jz/tetris-rs
  cd tetris-rs
  cargo run                      # 运行开发版本
  cargo build --release          # 构建发布版本
  ```

### 控制键位

| 操作      | 按键               |
| :-------- | :----------------- |
| 左移/右移 | ← → / A D          |
| 旋转      | ↑ / W              |
| 软降/硬降 | ↓ S / Space        |
| 暂停/退出 | ESC / Q            |
| 重新开始  | Space (游戏结束后) |

### 参考文献

- [1] The Bevy Book. https://bevy.org/learn/quick-start/introduction/
- [2] The Rust Programming Language. https://doc.rust-lang.org/book/
